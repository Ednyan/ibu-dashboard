{% extends "base.html" %} {% block title %}I.B.U. Admin{% endblock %} {% block
content %}
<div class="mx-auto w-full max-w-6xl px-4 py-6">
  <header
    class="rounded-2xl border border-white/10 bg-neutral-800 p-5 shadow-sm"
  >
    <div
      class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"
    >
      <div>
        <h1 class="text-xl font-semibold tracking-wide text-white">Admin</h1>
        <p class="mt-1 text-sm text-white/70">
          Email recipients and member overrides
        </p>
      </div>
      <a
        href="{{ url_for('admin_logout') }}"
        class="inline-flex items-center justify-center rounded-xl border border-red-500/40 bg-red-500/15 px-4 py-2.5 text-sm font-semibold text-white hover:bg-red-500/25 focus:outline-none focus:ring-2 focus:ring-red-300/40"
      >
        Logout
      </a>
    </div>
  </header>

  {% with messages = get_flashed_messages(with_categories=true) %} {% if
  messages %}
  <div class="mt-4 space-y-2">
    {% for category, msg in messages %}
    <div
      class="rounded-xl border border-white/10 bg-black/20 p-3 text-sm {% if category == 'success' %} text-emerald-300 {% elif category == 'error' %} text-red-300 {% else %} text-white/80 {% endif %}"
    >
      {{ msg }}
    </div>
    {% endfor %}
  </div>
  {% endif %} {% endwith %}

  <div class="mt-4 grid grid-cols-1 gap-4 lg:grid-cols-1">
    <section
      class="rounded-2xl border border-white/10 bg-neutral-800 p-5 shadow-sm {% if status.enabled %} ring-2 ring-emerald-500/60 {% else %} ring-2 ring-red-500/60 {% endif %}"
    >
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="text-base font-semibold text-white">System Status</h2>
        </div>

        <div class="flex flex-wrap gap-2">
          <form method="post" action="{{ url_for('admin_notification_test') }}">
            {% set test_disabled = (not status.enabled) or (not
            status.sender_configured) or (status.admin_emails_configured|int <=
            0) %}

            <button
              type="submit"
              class="inline-flex items-center justify-center rounded-xl bg-rose-500 px-4 py-2.5 text-sm font-semibold text-white hover:bg-rose-400 disabled:opacity-50"
              {%
              if
              test_disabled
              %}disabled{%
              endif
              %}
            >
              Send Test Email
            </button>
          </form>

          <a
            href="{{ url_for('notification_admin') }}"
            class="inline-flex items-center justify-center rounded-xl bg-indigo-500 px-4 py-2.5 text-sm font-semibold text-white hover:bg-indigo-400"
          >
            Refresh
          </a>
        </div>
      </div>

      {% if not status.enabled or not status.sender_configured or
      status.admin_emails_configured|int <= 0 %}
      <div
        class="mt-4 rounded-xl border border-amber-400/30 bg-amber-500/10 p-4 text-sm text-amber-200"
      >
        Email notifications are not fully configured. {% if not status.enabled
        %}
        <div class="mt-2">
          Status: Disabled{% if status.error %} â€” {{ status.error }}{% endif %}
        </div>
        {% endif %} {% if status.enabled and not status.sender_configured %}
        <div class="mt-2">Sender is not configured.</div>
        {% endif %} {% if status.enabled and status.admin_emails_configured|int
        <= 0 %}
        <div class="mt-2">No admin recipients configured.</div>
        {% endif %}
      </div>
      {% endif %}

      <div class="mt-4 text-sm text-white/80">
        <div
          class="flex items-start justify-between gap-4 py-2 border-b border-white/10"
        >
          <span class="text-white/60">Status</span>
          <span class="text-right font-semibold">
            {% if status.enabled %}<span class="text-emerald-300">Enabled</span>
            {% else %}<span class="text-red-300">Disabled</span>{% endif %}
          </span>
        </div>

        {% if status.enabled %}
        <div
          class="flex items-start justify-between gap-4 py-2 border-b border-white/10"
        >
          <span class="text-white/60">SMTP</span>
          <span class="text-right font-semibold text-white">
            {{ status.smtp_server }}:{{ status.smtp_port }}
          </span>
        </div>

        <div
          class="flex items-start justify-between gap-4 py-2 border-b border-white/10"
        >
          <span class="text-white/60">Sender</span>
          <span
            class="text-right font-semibold {% if status.sender_configured %}text-emerald-300{% else %}text-red-300{% endif %}"
          >
            {{ status.sender_email or "Not configured" }}
          </span>
        </div>

        <div
          class="flex items-start justify-between gap-4 py-2 border-b border-white/10"
        >
          <span class="text-white/60">Admin recipients</span>
          <span
            class="text-right font-semibold {% if status.admin_emails_configured|int > 0 %}text-emerald-300{% else %}text-red-300{% endif %}"
          >
            {{ status.admin_emails_configured|int }}
          </span>
        </div>

        <div
          class="flex items-start justify-between gap-4 py-2 border-b border-white/10"
        >
          <span class="text-white/60">Notifications sent</span>
          <span class="text-right font-semibold text-white">
            {{ status.notification_history_count }}
          </span>
        </div>

        {% if status.admin_emails %}
        <div class="flex items-start justify-between gap-4 py-2">
          <span class="text-white/60">Recipients</span>
          <span class="text-right font-semibold text-white">
            {{ status.admin_emails|join(", ") }}
          </span>
        </div>
        {% endif %} {% endif %}
      </div>
    </section>

    <section
      class="rounded-2xl border border-white/10 bg-neutral-800 p-5 shadow-sm"
    >
      <h2 class="text-base font-semibold text-white">Admin Recipients</h2>
      <p class="mt-1 text-sm text-white/70">
        Add/remove emails and toggle what they receive.
      </p>

      <form
        method="post"
        action="{{ url_for('admin_emails_add') }}"
        class="mt-4 flex flex-col gap-2 sm:flex-row sm:items-center"
      >
        <input
          name="email"
          type="email"
          required
          placeholder="name@example.com"
          class="w-full flex-1 rounded-xl border border-white/10 bg-neutral-800 py-2.5 px-3 text-sm text-white placeholder:text-white/40 outline-none focus:border-white/20 focus:bg-white/10"
        />
        <button
          type="submit"
          class="inline-flex items-center justify-center rounded-xl bg-rose-500 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-rose-400 focus:outline-none focus:ring-2 focus:ring-rose-300/60"
        >
          Add
        </button>
      </form>

      <div class="mt-3 divide-y divide-white/10">
        {% if not recipients %}
        <div class="py-3 text-sm text-white/60">No recipients configured.</div>
        {% else %} {% for r in recipients %} {% set email = r.email %} {% set p
        = r.prefs or {} %}
        <div
          class="flex flex-col gap-3 py-3 sm:flex-row sm:items-center sm:justify-between"
        >
          <div class="text-sm font-semibold text-white break-all">
            {{ email }}
          </div>

          <form
            method="post"
            action="{{ url_for('admin_emails_update_prefs') }}"
            class="flex flex-wrap items-center gap-4 text-sm text-white/70"
          >
            <input type="hidden" name="email" value="{{ email }}" />
            <label class="inline-flex items-center gap-2">
              <input
                type="checkbox"
                class="h-4 w-4 accent-emerald-500"
                name="failed"
                value="1"
                {%
                if
                p.failed
                %}checked{%
                endif
                %}
                onchange="this.form.submit()"
              />
              Failed
            </label>
            <label class="inline-flex items-center gap-2">
              <input
                type="checkbox"
                class="h-4 w-4 accent-emerald-500"
                name="passed"
                value="1"
                {%
                if
                p.passed
                %}checked{%
                endif
                %}
                onchange="this.form.submit()"
              />
              Passed
            </label>
            <label class="inline-flex items-center gap-2">
              <input
                type="checkbox"
                class="h-4 w-4 accent-emerald-500"
                name="non_compliant"
                value="1"
                {%
                if
                p.non_compliant
                %}checked{%
                endif
                %}
                onchange="this.form.submit()"
              />
              Non-compliant
            </label>
          </form>

          <form method="post" action="{{ url_for('admin_emails_remove') }}">
            <input type="hidden" name="email" value="{{ email }}" />
            <button
              type="submit"
              class="inline-flex items-center justify-center rounded-xl bg-rose-500 px-3 py-2 text-xs font-semibold text-white hover:bg-rose-400 focus:outline-none focus:ring-2 focus:ring-rose-300/60"
            >
              Remove
            </button>
          </form>
        </div>
        {% endfor %} {% endif %}
      </div>
    </section>

    <section
      class="rounded-2xl border border-white/10 bg-neutral-800 p-5 shadow-sm"
    >
      <h2 class="text-base font-semibold text-white">Overrides</h2>
      <p class="mt-1 text-sm text-white/70">
        Per member: Week 1, Month 1, Month 3 (None/Pass/Fail).
      </p>

      <div class="mt-4 flex flex-col gap-2 sm:flex-row sm:items-center">
        <input
          id="ovFilter"
          placeholder="Filter members..."
          class="w-full flex-1 rounded-xl border border-white/10 bg-neutral-800 py-2.5 px-3 text-sm text-white placeholder:text-white/40 outline-none focus:border-white/20 focus:bg-white/10"
        />
        <a
          href="{{ url_for('notification_admin') }}"
          class="inline-flex items-center justify-center rounded-xl bg-indigo-500 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-300/60"
        >
          Reload
        </a>
      </div>

      <div class="mt-3 overflow-x-auto">
        <div class="min-w-190 rounded-xl border border-white/10">
          <div
            class="grid grid-cols-5 gap-3 bg-white/5 px-3 py-2 text-xs font-semibold text-white/80"
          >
            <div>Member</div>
            <div class="text-center">Week 1</div>
            <div class="text-center">Month 1</div>
            <div class="text-center">Month 3</div>
            <div class="text-right">Actions</div>
          </div>

          <div id="ovGrid" class="divide-y divide-white/10">
            {% for m in members %} {% set o = m.overrides or {} %}
            <div
              class="ov-row grid grid-cols-5 items-center gap-3 px-3 py-3 text-sm"
              data-name="{{ m.name|lower }}"
            >
              <div class="font-medium text-white">{{ m.name }}</div>

              {% for key, label in [("week_1","Week 1"),("month_1","Month
              1"),("month_3","Month 3")] %} {% set val = o.get(key) %}
              <div class="text-center">
                <form
                  method="post"
                  action="{{ url_for('admin_overrides_set') }}"
                  class="inline-flex overflow-hidden rounded-xl border border-white/10 bg-white/5"
                >
                  <input type="hidden" name="member" value="{{ m.name }}" />
                  <input type="hidden" name="key" value="{{ key }}" />

                  <button
                    type="submit"
                    name="val"
                    value=""
                    class="px-3 py-1.5 text-xs font-semibold {% if val is none %} bg-slate-600 text-white {% else %} text-white/80 hover:bg-white/10 {% endif %}"
                  >
                    None
                  </button>
                  <button
                    type="submit"
                    name="val"
                    value="true"
                    class="border-l border-white/10 px-3 py-1.5 text-xs font-semibold {% if val is sameas true %} bg-emerald-600 text-white {% else %} text-white/80 hover:bg-white/10 {% endif %}"
                  >
                    Pass
                  </button>
                  <button
                    type="submit"
                    name="val"
                    value="false"
                    class="border-l border-white/10 px-3 py-1.5 text-xs font-semibold {% if val is sameas false %} bg-red-600 text-white {% else %} text-white/80 hover:bg-white/10 {% endif %}"
                  >
                    Fail
                  </button>
                </form>
              </div>
              {% endfor %}

              <div class="text-right">
                <form
                  method="post"
                  action="{{ url_for('admin_overrides_clear') }}"
                >
                  <input type="hidden" name="member" value="{{ m.name }}" />
                  <button
                    type="submit"
                    class="inline-flex items-center justify-center rounded-xl bg-rose-500 px-3 py-2 text-xs font-semibold text-white hover:bg-rose-400 focus:outline-none focus:ring-2 focus:ring-rose-300/60"
                  >
                    Clear
                  </button>
                </form>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  (function () {
    const input = document.getElementById("ovFilter");
    const grid = document.getElementById("ovGrid");
    if (!input || !grid) return;

    input.addEventListener("input", () => {
      const q = (input.value || "").trim().toLowerCase();
      grid.querySelectorAll(".ov-row").forEach((row) => {
        const name = row.getAttribute("data-name") || "";
        row.classList.toggle("hidden", q && !name.includes(q));
      });
    });
  })();
</script>
{% endblock %}
