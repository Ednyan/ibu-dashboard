{% extends "base.html" %} {% block title %}I.B.U. Trends{% endblock %} {% block
content %}
<div class="mx-auto w-full max-w-6xl px-4 py-6">
  <!-- Header -->
  <header
    class="rounded-2xl border border-white/10 bg-neutral-800 p-5 shadow-sm"
  >
    <div
      class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between"
    >
      <div>
        <h1 class="text-xl font-semibold tracking-wide text-white">Trends</h1>
        <p class="mt-1 text-sm text-white/70">
          Data from {{ time_ago }} ({{ latest_date }})
        </p>
      </div>
    </div>
  </header>

  <!-- Controls + Chart -->
  <div class="mt-4 grid grid-cols-1 gap-4 lg:grid-cols-12">
    <!-- Controls -->
    <aside class="lg:col-span-4">
      <div
        class="rounded-2xl border border-white/10 bg-neutral-800 p-4 backdrop-blur-2xl"
      >
        <!-- Chart type -->
        <div class="border-b border-white/10 pb-4">
          <div class="text-xs font-semibold text-white/70">Chart Type</div>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <label
              class="flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white/90"
            >
              <input type="radio" name="chartType" value="line" checked />
              <span>Line</span>
            </label>
            <label
              class="flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white/90"
            >
              <input type="radio" name="chartType" value="bar" />
              <span>Bar</span>
            </label>
          </div>

          <div id="fillLinesWrapper" class="mt-2">
            <label class="flex items-center gap-2 text-xs text-white/70">
              <input type="checkbox" id="fillLinesToggle" checked />
              <span>Fill Lines</span>
            </label>
          </div>
        </div>

        <!-- Value mode -->
        <div class="border-b border-white/10 py-4">
          <div class="text-xs font-semibold text-white/70">Value Mode</div>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <label
              class="flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white/90"
            >
              <input type="radio" name="valueMode" value="cumulative" />
              <span>Cumulative</span>
            </label>
            <label
              class="flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white/90"
            >
              <input type="radio" name="valueMode" value="interval" checked />
              <span>Interval</span>
            </label>
          </div>
        </div>

        <!-- Hover -->
        <div class="border-b border-white/10 py-4">
          <div class="text-xs font-semibold text-white/70">Hover</div>
          <div class="mt-2 grid grid-cols-3 gap-2">
            <label
              class="flex items-center justify-center gap-2 rounded-xl border border-white/10 bg-white/5 px-2 py-2 text-xs text-white/90"
            >
              <input type="radio" name="hoverMode" value="x" />
              <span>Separate</span>
            </label>
            <label
              class="flex items-center justify-center gap-2 rounded-xl border border-white/10 bg-white/5 px-2 py-2 text-xs text-white/90"
            >
              <input type="radio" name="hoverMode" value="x unified" checked />
              <span>Unified</span>
            </label>
            <label
              class="flex items-center justify-center gap-2 rounded-xl border border-white/10 bg-white/5 px-2 py-2 text-xs text-white/90"
            >
              <input type="radio" name="hoverMode" value="closest" />
              <span>Closest</span>
            </label>
          </div>
        </div>

        <!-- Time period -->
        <div class="border-b border-white/10 py-4">
          <div class="text-xs font-semibold text-white/70">Time Period</div>
          <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
            <label
              class="flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-white/90"
            >
              <input type="radio" name="timePeriod" value="daily" checked />
              <span>Daily</span>
            </label>
            <label
              class="flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-white/90"
            >
              <input type="radio" name="timePeriod" value="weekly" />
              <span>Weekly</span>
            </label>
            <label
              class="flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-white/90"
            >
              <input type="radio" name="timePeriod" value="monthly" />
              <span>Monthly</span>
            </label>
            <label
              class="flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-white/90"
            >
              <input type="radio" name="timePeriod" value="yearly" />
              <span>Yearly</span>
            </label>
            <label
              class="flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-white/90"
            >
              <input type="radio" name="timePeriod" value="90_days" />
              <span>90 Days</span>
            </label>
            <label
              class="flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-white/90"
            >
              <input type="radio" name="timePeriod" value="180_days" />
              <span>180 Days</span>
            </label>
          </div>
        </div>

        <!-- Date range -->
        <div class="border-b border-white/10 py-4">
          <div class="text-xs font-semibold text-white/70">Date Range</div>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs text-white/50">Start</label>
              <input
                id="startDate"
                type="date"
                class="mt-1 w-full rounded-xl border border-white/10 bg-white/5 py-2 px-3 text-sm text-white outline-none focus:border-white/20 focus:bg-white/10"
              />
            </div>
            <div>
              <label class="text-xs text-white/50">End</label>
              <input
                id="endDate"
                type="date"
                class="mt-1 w-full rounded-xl border border-white/10 bg-white/5 py-2 px-3 text-sm text-white outline-none focus:border-white/20 focus:bg-white/10"
              />
            </div>
            <button
              id="applyDateRange"
              class="col-span-2 rounded-xl border border-white/10 bg-white/10 px-3 py-2 text-sm text-white/90 hover:bg-white/15"
            >
              Apply
            </button>
          </div>

          <div class="mt-2 flex flex-wrap gap-2">
            <button
              class="mini-btn rounded-lg border border-white/10 bg-white/5 px-2 py-1 text-xs text-white/80 hover:bg-white/10"
              data-range="1m"
            >
              1M
            </button>
            <button
              class="mini-btn rounded-lg border border-white/10 bg-white/5 px-2 py-1 text-xs text-white/80 hover:bg-white/10"
              data-range="3m"
            >
              3M
            </button>
            <button
              class="mini-btn rounded-lg border border-white/10 bg-white/5 px-2 py-1 text-xs text-white/80 hover:bg-white/10"
              data-range="6m"
            >
              6M
            </button>
            <button
              class="mini-btn rounded-lg border border-white/10 bg-white/5 px-2 py-1 text-xs text-white/80 hover:bg-white/10"
              data-range="1y"
            >
              1Y
            </button>
            <button
              class="mini-btn rounded-lg border border-white/10 bg-white/5 px-2 py-1 text-xs text-white/80 hover:bg-white/10"
              data-range="all"
            >
              All
            </button>
          </div>
        </div>
        <!-- Teams -->
        <div class="border-t border-white/10 pt-4">
          <div class="text-xs font-semibold text-white/70">Teams (Top 150)</div>

          <input
            id="teamSearch"
            type="text"
            placeholder="Search teams..."
            class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 py-3 px-4 text-sm text-white placeholder:text-white/40 outline-none focus:border-white/20 focus:bg-white/10"
          />

          <div class="mt-2 flex gap-2">
            <button
              type="button"
              id="enableAllTeams"
              class="flex-1 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs text-white/80 hover:bg-white/10"
            >
              Enable All
            </button>
            <button
              type="button"
              id="disableAllTeams"
              class="flex-1 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs text-white/80 hover:bg-white/10"
            >
              Disable All
            </button>
          </div>

          <!-- teams dropdown list -->
          <div
            id="teamDropdown"
            class="mt-3 max-h-64 overflow-auto rounded-xl border border-white/10 bg-white/5"
          ></div>

          <!-- Team metric (only relevant when at least 1 team is selected) -->
          <div id="teamMetricWrapper" class="mt-3 hidden">
            <label class="text-xs text-white/50">Team Metric</label>
            <select
              id="teamMetric"
              class="mt-1 w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-white/20 focus:bg-white/10"
            >
              <option value="total_points" selected>Total Points</option>
              <option value="members">Members</option>
              <option value="90_days">90 Days</option>
              <option value="180_days">180 Days</option>
            </select>
          </div>
        </div>

        <!-- Series -->
        <div class="py-4">
          <div class="text-xs font-semibold text-white/70">Data Series</div>

          <input
            id="memberSearch"
            type="text"
            placeholder="Search members..."
            class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 py-3 px-4 text-sm text-white placeholder:text-white/40 outline-none focus:border-white/20 focus:bg-white/10"
          />

          <div class="mt-2 flex gap-2">
            <button
              type="button"
              id="enableAllMembers"
              class="flex-1 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs text-white/80 hover:bg-white/10"
            >
              Enable All
            </button>
            <button
              type="button"
              id="disableAllMembers"
              class="flex-1 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs text-white/80 hover:bg-white/10"
            >
              Disable All
            </button>
          </div>

          <!-- dropdown list -->
          <div
            id="memberDropdown"
            class="mt-3 max-h-64 overflow-auto rounded-xl border border-white/10 bg-white/5"
          >
            <div
              class="px-3 py-2 text-sm text-white/90 border-b border-white/10"
            >
              <label class="flex items-center justify-between gap-3">
                <span class="flex items-center gap-2 min-w-0">
                  <input type="checkbox" value="total" checked />
                  <span class="truncate">ðŸ“Š Total Team Points</span>
                </span>
                <span class="text-xs text-white/40">total</span>
              </label>
            </div>
          </div>

          <div id="selectedSeries" class="mt-3 flex flex-wrap gap-2"></div>
        </div>

        <!-- Predictions -->
        <div class="border-t border-white/10 pt-4">
          <div class="flex items-center justify-between">
            <div class="text-xs font-semibold text-white/70">Predictions</div>
            <label class="flex items-center gap-2 text-xs text-white/70">
              <input type="checkbox" id="enablePredictions" />
              <span>Enable</span>
            </label>
          </div>

          <div id="predictionOptions" class="mt-3 hidden">
            <label class="text-xs text-white/50">Method</label>
            <select
              id="predictionMethod"
              class="mt-1 w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-white/20 focus:bg-white/10"
            >
              <option value="linear">Linear Regression</option>
              <option value="moving_average">Moving Average</option>
            </select>

            <label class="mt-3 block text-xs text-white/50">Days</label>
            <input
              id="predictionDays"
              type="number"
              value="30"
              min="7"
              max="365"
              class="mt-1 w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white outline-none focus:border-white/20 focus:bg-white/10"
            />
          </div>
        </div>
      </div>
    </aside>

    <!-- Chart -->
    <main class="lg:col-span-8">
      <div
        class="overflow-hidden rounded-2xl border border-white/10 bg-neutral-800 backdrop-blur-2xl"
      >
        <div
          class="flex flex-col gap-2 border-b border-white/10 px-5 py-4 sm:flex-row sm:items-center sm:justify-between"
        >
          <div>
            <h2 class="text-sm font-semibold text-white">
              Team Performance Trends
            </h2>
            <p id="chartInfo" class="mt-1 text-xs text-white/60">Loading...</p>
          </div>
        </div>

        <div class="relative p-4">
          <div class="h-[360px] sm:h-[420px]">
            <canvas id="trendsCanvas"></canvas>
          </div>

          <div
            id="emptyState"
            class="absolute inset-0 flex items-center justify-center"
          >
            <div
              class="rounded-xl border border-white/10 bg-gray-950/60 p-4 text-sm text-white/80 backdrop-blur"
            >
              No data returned. Select at least one series and verify date
              range.
            </div>
          </div>

          <div
            id="loadingSpinner"
            class="absolute inset-0 flex items-center justify-center bg-black/40"
          >
            <div
              class="rounded-xl border border-white/10 bg-gray-950/60 px-4 py-3 text-sm text-white/90 backdrop-blur"
            >
              Loading trends data...
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Chart.js + date adapter -->

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

<script>
  let availableMembers = [];
  let availableTeams = [];

  let selectedSeries = new Set(["total"]);
  let earliestDate = null;
  let chart = null;

  document.addEventListener("DOMContentLoaded", () => {
    initDates();
    fetchMembers();
    fetchTeams();
    bindEvents();
    updateSelectedTags();
    enforceChartConstraints();
    updateChart();
  });

  function fmt(d) {
    return d.toISOString().split("T")[0];
  }

  function initDates() {
    const end = new Date();
    const start = new Date("2023-09-01T00:00:00");
    document.getElementById("endDate").value = fmt(end);
    document.getElementById("startDate").value = fmt(start);
  }

  function formatCompact(n) {
    if (n == null || isNaN(n)) return "0";
    const abs = Math.abs(n);
    if (abs >= 1_000_000) return Math.floor(abs / 1_000_000) + " M";
    if (abs >= 1_000) return Math.floor(abs / 1_000) + "k";
    return "" + abs;
  }

  function bindEvents() {
    document
      .getElementById("enableAllTeams")
      .addEventListener("click", enableAllTeams);
    document
      .getElementById("disableAllTeams")
      .addEventListener("click", disableAllTeams);

    const teamSearch = document.getElementById("teamSearch");
    teamSearch.addEventListener("input", () => filterTeams(teamSearch.value));

    document
      .getElementById("teamMetric")
      .addEventListener("change", updateChart);

    document.querySelectorAll('input[name="chartType"]').forEach((r) =>
      r.addEventListener("change", () => {
        enforceChartConstraints();
        updateChart();
      }),
    );

    document
      .querySelectorAll('input[name="valueMode"]')
      .forEach((r) => r.addEventListener("change", updateChart));
    document
      .querySelectorAll('input[name="timePeriod"]')
      .forEach((r) => r.addEventListener("change", updateChart));
    document
      .querySelectorAll('input[name="hoverMode"]')
      .forEach((r) => r.addEventListener("change", updateChart));

    document
      .getElementById("applyDateRange")
      .addEventListener("click", updateChart);

    document.querySelectorAll(".mini-btn[data-range]").forEach((btn) => {
      btn.addEventListener("click", () => setQuickRange(btn.dataset.range));
    });

    document
      .getElementById("fillLinesToggle")
      .addEventListener("change", updateChart);

    document
      .getElementById("enablePredictions")
      .addEventListener("change", (e) => {
        document
          .getElementById("predictionOptions")
          .classList.toggle("hidden", !e.target.checked);
        updateChart();
      });
    document
      .getElementById("predictionMethod")
      .addEventListener("change", updateChart);
    document
      .getElementById("predictionDays")
      .addEventListener("change", updateChart);

    document
      .getElementById("enableAllMembers")
      .addEventListener("click", enableAllMembers);
    document
      .getElementById("disableAllMembers")
      .addEventListener("click", disableAllMembers);

    const search = document.getElementById("memberSearch");
    search.addEventListener("input", () => filterMembers(search.value));

    // total checkbox behavior (exists initially)
    document
      .querySelector('#memberDropdown input[value="total"]')
      .addEventListener("change", (e) => {
        if (e.target.checked) selectedSeries.add("total");
        else selectedSeries.delete("total");
        if (selectedSeries.size === 0) selectedSeries.add("total"); // force at least one
        updateSelectedTags();
        updateChart();
      });
  }

  function enforceChartConstraints() {
    const isLine =
      document.querySelector('input[name="chartType"]:checked').value ===
      "line";
    document.getElementById("fillLinesWrapper").style.display = isLine
      ? "block"
      : "none";
  }

  function setQuickRange(r) {
    const end = new Date();
    let start = new Date();
    if (r === "1m") start.setMonth(end.getMonth() - 1);
    else if (r === "3m") start.setMonth(end.getMonth() - 3);
    else if (r === "6m") start.setMonth(end.getMonth() - 6);
    else if (r === "1y") start.setFullYear(end.getFullYear() - 1);
    else if (r === "all" && earliestDate)
      start = new Date(earliestDate + "T00:00:00");

    document.getElementById("endDate").value = fmt(end);
    document.getElementById("startDate").value = fmt(start);
    updateChart();
  }
  // ---- Teams list ----
  function fetchTeams() {
    fetch("/api/trends/teams")
      .then((r) => r.json())
      .then((data) => {
        if (!data.success)
          throw new Error(data.error || "Failed to load teams");
        availableTeams = data.teams || [];
        populateTeamDropdown();
      })
      .catch((e) => console.error(e));
  }

  function populateTeamDropdown() {
    const dropdown = document.getElementById("teamDropdown");
    dropdown.innerHTML = "";

    availableTeams.forEach((t) => {
      const teamName = t.name || "";
      const seriesValue = `team:${teamName}`;

      const row = document.createElement("div");
      row.className =
        "px-3 py-2 text-sm text-white/90 border-b border-white/10 team-row";
      row.dataset.name = teamName.toLowerCase();

      row.innerHTML = `
      <label class="flex items-center justify-between gap-3" title="${teamName} â€¢ ${Number(t.total_points || 0).toLocaleString()} pts">
        <span class="flex items-center gap-2 min-w-0">
          <input type="checkbox" value="${seriesValue}">
          <span class="truncate">${teamName}</span>
        </span>
        <span class="text-xs text-white/40 whitespace-nowrap">${formatCompact(t.total_points)} pts</span>
      </label>
    `;

      row.querySelector("input").addEventListener("change", (e) => {
        if (e.target.checked) selectedSeries.add(e.target.value);
        else selectedSeries.delete(e.target.value);

        if (selectedSeries.size === 0) selectedSeries.add("total");
        syncCheckboxes();
        updateSelectedTags();
        updateTeamMetricVisibility();
        updateChart();
      });

      dropdown.appendChild(row);
    });

    syncCheckboxes();
    updateSelectedTags();
    updateTeamMetricVisibility();
  }

  function filterTeams(term) {
    const q = (term || "").toLowerCase().trim();
    document.querySelectorAll("#teamDropdown .team-row").forEach((r) => {
      const name = r.dataset.name || "";
      r.style.display = name.includes(q) ? "" : "none";
    });
  }

  function enableAllTeams() {
    availableTeams.forEach((t) => selectedSeries.add(`team:${t.name}`));
    syncCheckboxes();
    updateSelectedTags();
    updateTeamMetricVisibility();
    updateChart();
  }

  function disableAllTeams() {
    // remove only team series
    Array.from(selectedSeries).forEach((v) => {
      if (v.startsWith("team:")) selectedSeries.delete(v);
    });

    if (selectedSeries.size === 0) selectedSeries.add("total");
    syncCheckboxes();
    updateSelectedTags();
    updateTeamMetricVisibility();
    updateChart();
  }

  function updateTeamMetricVisibility() {
    const anyTeam = Array.from(selectedSeries).some((s) =>
      s.startsWith("team:"),
    );
    document
      .getElementById("teamMetricWrapper")
      .classList.toggle("hidden", !anyTeam);
  }

  // ---- Members list ----
  function fetchMembers() {
    fetch("/api/trends/members")
      .then((r) => r.json())
      .then((data) => {
        if (!data.success)
          throw new Error(data.error || "Failed to load members");
        availableMembers = data.members || [];
        earliestDate = data.earliest_date || null;
        populateMemberDropdown();
      })
      .catch((e) => console.error(e));
  }

  function populateMemberDropdown() {
    const dropdown = document.getElementById("memberDropdown");

    // Remove any previous injected member rows (keep the first total row)
    const totalRow = dropdown.querySelector(":scope > div"); // first child is total row
    dropdown.innerHTML = "";
    dropdown.appendChild(totalRow);

    availableMembers.forEach((m) => {
      const row = document.createElement("div");
      row.className =
        "px-3 py-2 text-sm text-white/90 border-b border-white/10 member-row";
      row.dataset.name = (m.name || "").toLowerCase();

      row.innerHTML = `
        <label class="flex items-center justify-between gap-3" title="${m.name} â€¢ ${Number(m.current_points || 0).toLocaleString()} pts">
          <span class="flex items-center gap-2 min-w-0">
            <input type="checkbox" value="${m.name}">
            <span class="truncate">${m.name}</span>
          </span>
          <span class="text-xs text-white/40 whitespace-nowrap">${formatCompact(m.current_points)} pts</span>
        </label>
      `;

      row.querySelector("input").addEventListener("change", (e) => {
        if (e.target.checked) selectedSeries.add(e.target.value);
        else selectedSeries.delete(e.target.value);

        if (selectedSeries.size === 0) selectedSeries.add("total"); // force at least one
        syncCheckboxes();
        updateSelectedTags();
        updateChart();
      });

      dropdown.appendChild(row);
    });

    syncCheckboxes();
    updateSelectedTags();
  }

  function filterMembers(term) {
    const q = (term || "").toLowerCase().trim();
    document.querySelectorAll("#memberDropdown .member-row").forEach((r) => {
      const name = r.dataset.name || "";
      r.style.display = name.includes(q) ? "" : "none";
    });
  }

  function enableAllMembers() {
    selectedSeries.add("total");
    availableMembers.forEach((m) => selectedSeries.add(m.name));
    syncCheckboxes();
    updateSelectedTags();
    updateChart();
  }

  function disableAllMembers() {
    selectedSeries.clear();
    selectedSeries.add("total"); // keep at least total
    syncCheckboxes();
    updateSelectedTags();
    updateChart();
  }

  function syncCheckboxes() {
    document
      .querySelectorAll('#memberDropdown input[type="checkbox"]')
      .forEach((cb) => {
        cb.checked = selectedSeries.has(cb.value);
      });

    document
      .querySelectorAll('#teamDropdown input[type="checkbox"]')
      .forEach((cb) => {
        cb.checked = selectedSeries.has(cb.value);
      });
  }

  function updateSelectedTags() {
    const c = document.getElementById("selectedSeries");
    c.innerHTML = "";

    Array.from(selectedSeries).forEach((s) => {
      const tag = document.createElement("div");
      tag.className =
        "inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-white/80";

      let label = s;
      if (s === "total") label = " Total Team Points";
      else if (s.startsWith("team:")) label = " " + s.substring(5);

      tag.innerHTML = `<span class="max-w-[18rem] truncate">${label}</span>
                       <button class="text-white/60 hover:text-white" aria-label="remove">Ã—</button>`;

      tag.querySelector("button").addEventListener("click", () => {
        selectedSeries.delete(s);
        if (selectedSeries.size === 0) selectedSeries.add("total");
        syncCheckboxes();
        updateSelectedTags();
        updateTeamMetricVisibility();
        updateChart();
      });

      c.appendChild(tag);
    });
  }

  // ---- Chart.js ----
  function toggleLoading(show) {
    document.getElementById("loadingSpinner").classList.toggle("hidden", !show);
  }
  function toggleEmpty(show) {
    document.getElementById("emptyState").classList.toggle("hidden", !show);
  }

  function destroyChart() {
    if (chart) {
      chart.destroy();
      chart = null;
    }
  }

  function interactionFromPlotlyHoverMode(plotlyMode) {
    // plotlyMode from your UI: "x unified", "closest", "x"
    if (plotlyMode === "x unified") return { mode: "index", intersect: false };
    if (plotlyMode === "x") return { mode: "nearest", intersect: false };
    return { mode: "nearest", intersect: true };
  }

  function buildOptions(yTitle, hoverMode) {
    return {
      responsive: true,
      maintainAspectRatio: false,
      interaction: interactionFromPlotlyHoverMode(hoverMode),
      plugins: {
        legend: {
          position: "top",
          labels: { color: "rgba(255,255,255,0.75)" },
        },
        tooltip: { enabled: true },
      },
      scales: {
        x: {
          type: "time",
          time: { unit: "day" },
          ticks: { color: "rgba(255,255,255,0.55)" },
          grid: { color: "rgba(255,255,255,0.08)" },
        },
        y: {
          beginAtZero: true,
          ticks: {
            color: "rgba(255,255,255,0.55)",
            callback: (v) => formatCompact(v),
          },
          title: {
            display: true,
            text: yTitle,
            color: "rgba(255,255,255,0.75)",
          },
          grid: { color: "rgba(255,255,255,0.08)" },
        },
      },
    };
  }

  function plotlyTracesToDatasets(traces, chartType, fillLines) {
    // Your backend traces for line/bar are Plotly-like:
    // scatter: {type:"scatter", x:[...], y:[...], name:"...", line:{color:"#..."}}
    // bar:     {type:"bar", x:[...], y:[...], name:"..."}
    return (traces || []).map((t) => {
      const x = t.x || [];
      const y = t.y || [];
      const color = t?.line?.color || t?.marker?.color || undefined;

      const data = x.map((xs, i) => ({ x: xs, y: y[i] }));

      const isBar = chartType === "bar";
      const isScatter = (t.type || "").toLowerCase() === "scatter";

      // If backend sends scatter but user wants bar, still render as bar (and vice versa).
      const finalType = isBar ? "bar" : "line";

      const ds = {
        type: finalType,
        label: t.name || "Series",
        data,
        borderWidth: isBar ? 0 : 2,
        pointRadius: isBar ? 0 : 2,
        fill: !isBar && fillLines ? true : false,
      };

      // only set colors if backend provides one
      if (color) {
        ds.borderColor = color;
        ds.backgroundColor = color;
      }

      return ds;
    });
  }

  function updateChartInfo(payload) {
    const tp = document.querySelector('input[name="timePeriod"]:checked').value;
    document.getElementById("chartInfo").textContent =
      `${selectedSeries.size} series â€¢ ${tp}`;
  }

  async function updateChart() {
    // Force at least one series
    if (selectedSeries.size === 0) selectedSeries.add("total");

    toggleLoading(true);
    toggleEmpty(false);

    const chartType = document.querySelector(
      'input[name="chartType"]:checked',
    ).value;
    const valueMode = document.querySelector(
      'input[name="valueMode"]:checked',
    ).value;
    const hoverMode = document.querySelector(
      'input[name="hoverMode"]:checked',
    ).value;
    const fillLines = document.getElementById("fillLinesToggle").checked;

    const params = new URLSearchParams({
      chart_type: chartType,
      time_period: document.querySelector('input[name="timePeriod"]:checked')
        .value,
      start_date: document.getElementById("startDate").value,
      end_date: document.getElementById("endDate").value,
      series: Array.from(selectedSeries).join(","),
      value_mode: valueMode,
      predictions: document.getElementById("enablePredictions").checked
        ? "true"
        : "false",
      prediction_method: document.getElementById("predictionMethod").value,
      prediction_days: document.getElementById("predictionDays").value,
      fill_lines: fillLines ? "true" : "false",
    });
    if (Array.from(selectedSeries).some((s) => s.startsWith("team:"))) {
      params.set("team_metric", document.getElementById("teamMetric").value);
    }

    try {
      const res = await fetch(`/api/trends/data?${params.toString()}`);
      const payload = await res.json();

      if (!payload.success)
        throw new Error(payload.error || "Failed to load chart data");

      // If backend returned no traces, show empty state and stop
      if (!Array.isArray(payload.data) || payload.data.length === 0) {
        destroyChart();
        toggleEmpty(true);
        updateChartInfo(payload);
        return;
      }

      // Build datasets
      const datasets = plotlyTracesToDatasets(
        payload.data,
        chartType,
        fillLines,
      );

      // If datasets ended up empty, show empty
      if (!datasets.length) {
        destroyChart();
        toggleEmpty(true);
        updateChartInfo(payload);
        return;
      }

      const yTitle = valueMode === "interval" ? "Points Produced" : "Points";
      const ctx = document.getElementById("trendsCanvas").getContext("2d");

      destroyChart();
      chart = new Chart(ctx, {
        type: chartType === "bar" ? "bar" : "line",
        data: { datasets },
        options: buildOptions(yTitle, hoverMode),
      });

      updateChartInfo(payload);
    } catch (e) {
      console.error(e);
      destroyChart();
      toggleEmpty(true);
      document.getElementById("chartInfo").textContent =
        `Error: ${e.message || e}`;
    } finally {
      toggleLoading(false);
    }
  }
</script>
{% endblock %}
