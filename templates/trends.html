<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>I.B.U. TRENDS</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link
      rel="icon"
      type="image/svg+xml"
      href="{{ url_for('static', filename='ibu-icon.svg') }}"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='graphs-modern.css') }}"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='trends.css') }}"
    />
    <style>
      /* Force normal pointer cursor across the plotting region (override Plotly crosshair) */
      #trendsChart .draglayer,
      #trendsChart .nsewdrag,
      #trendsChart .nsdrag,
      #trendsChart .ewdrag,
      #trendsChart .swdrag,
      #trendsChart .sedrag,
      #trendsChart .nwdrag,
      #trendsChart .nedrag,
      #trendsChart .zoomlayer,
      #trendsChart .hoverlayer {
        cursor: default !important;
      }
    </style>
  </head>
  <body>
    <div class="particles-container" id="particles"></div>
    <div class="background-overlay"></div>
    <div class="main-container">
      <header class="header-section">
        <div class="header-content">
          <div class="title-section">
            <h1 class="main-title animate-slide-up">TRENDS & PREDICTIONS</h1>
            <p class="subtitle animate-slide-up" style="animation-delay: 0.2s">
              New data received {{ time_ago }} ({{ latest_date }})
            </p>
          </div>
          <div class="header-buttons">
            <a
              class="nav-button animate-slide-up"
              style="animation-delay: 0.4s; text-decoration: none"
              href="{{ url_for('index') }}"
              ><span>Main Page</span></a
            >
          </div>
        </div>
      </header>

      <nav
        class="horizontal-nav animate-slide-up"
        style="animation-delay: 0.4s"
      >
        <a href="{{ url_for('visualization') }}" class="nav-tab"
          ><span class="nav-icon">üìä</span><span>Points Data</span></a
        >
        <a href="{{ url_for('trends') }}" class="nav-tab active"
          ><span class="nav-icon">üìà</span><span>Trends</span></a
        >
        <a href="{{ url_for('member_info') }}" class="nav-tab"
          ><span class="nav-icon">üë•</span><span>Member Tracking</span></a
        >
      </nav>

      <div
        class="content-section trends-layout animate-slide-up"
        style="animation-delay: 0.6s"
      >
        <!-- Horizontal toolbar replacing vertical sidebar -->
        <aside class="trends-controls horizontal-toolbar">
          <div class="control-block">
            <h3>Chart Type</h3>
            <label class="radio-option"
              ><input type="radio" name="chartType" value="line" checked /><span
                class="radio-label"
                >Line</span
              ></label
            >
            <div
              id="fillLinesWrapper"
              style="margin-top: 6px; display: inline-flex"
            >
              <label class="checkbox-option" style="font-size: 12px">
                <input type="checkbox" id="fillLinesToggle" checked />
                <span class="checkbox-label">Fill Lines</span>
              </label>
            </div>
            <label class="radio-option" id="bar-option"
              ><input type="radio" name="chartType" value="bar" /><span
                class="radio-label"
                >Bar</span
              ></label
            >
            <label class="radio-option" id="candlestick-option"
              ><input type="radio" name="chartType" value="candlestick" /><span
                class="radio-label"
                >Candlestick</span
              ></label
            >
            <small
              style="
                display: block;
                opacity: 0.65;
                margin-top: 4px;
                font-size: 11px;
              "
            ></small>
          </div>
          <div class="control-block value-mode">
            <h3>Value Mode</h3>
            <label class="radio-option"
              ><input
                type="radio"
                name="valueMode"
                value="cumulative"
                checked
              /><span class="radio-label">Cumulative</span></label
            >
            <label class="radio-option"
              ><input type="radio" name="valueMode" value="interval" /><span
                class="radio-label"
                >Interval</span
              ></label
            >
            <small
              style="
                display: block;
                opacity: 0.7;
                margin-top: 4px;
                font-size: 14px;
              "
              >Cumulative = Points generated over time.</small
            >
            <small
              style="
                display: block;
                opacity: 0.7;
                margin-top: 4px;
                font-size: 14px;
              "
              >Interval = Points generated per specific interval.</small
            >
          </div>
          <div class="control-block hover-mode">
            <h3>Hover</h3>
            <label class="radio-option"
              ><input type="radio" name="hoverMode" value="x" /><span
                class="radio-label"
                >Separate</span
              ></label
            >
            <label class="radio-option"
              ><input type="radio" name="hoverMode" value="x unified" /><span
                class="radio-label"
                >Unified</span
              ></label
            >
            <label class="radio-option"
              ><input
                type="radio"
                name="hoverMode"
                value="closest"
                checked
              /><span class="radio-label">Closest</span></label
            >
          </div>
          <div class="control-block">
            <h3>Time Period</h3>
            <label class="radio-option" id="daily-option"
              ><input
                type="radio"
                name="timePeriod"
                value="daily"
                checked
              /><span class="radio-label">Daily</span></label
            >
            <label class="radio-option" id="weekly-option"
              ><input type="radio" name="timePeriod" value="weekly" /><span
                class="radio-label"
                >Weekly</span
              ></label
            >
            <label class="radio-option" id="monthly-option"
              ><input type="radio" name="timePeriod" value="monthly" /><span
                class="radio-label"
                >Monthly</span
              ></label
            >
            <label class="radio-option" id="ninetyday-option"
              ><input type="radio" name="timePeriod" value="90_days" /><span
                class="radio-label"
                >90 Days</span
              ></label
            >
            <label class="radio-option" id="oneeightyday-option"
              ><input type="radio" name="timePeriod" value="180_days" /><span
                class="radio-label"
                >180 Days</span
              ></label
            >
            <label class="radio-option" id="yearly-option"
              ><input type="radio" name="timePeriod" value="yearly" /><span
                class="radio-label"
                >Yearly</span
              ></label
            >
          </div>
          <div class="control-block">
            <h3>Date Range</h3>
            <div class="date-range-columns">
              <div class="date-range-stack">
                <label for="startDate" class="date-label">Start Date</label>
                <input type="date" id="startDate" class="date-input" />
                <label for="endDate" class="date-label">End Date</label>
                <input type="date" id="endDate" class="date-input" />
                <button id="applyDateRange" class="apply-button">Apply</button>
              </div>
              <div class="quick-ranges as-column">
                <button class="mini-btn" data-range="1m">1M</button>
                <button class="mini-btn" data-range="3m">3M</button>
                <button class="mini-btn" data-range="6m">6M</button>
                <button class="mini-btn" data-range="1y">1Y</button>
                <button class="mini-btn" data-range="all">All</button>
              </div>
            </div>
          </div>
          <div class="control-block">
            <h3>Data Series</h3>
            <div class="series-selector">
              <input
                type="text"
                id="memberSearch"
                placeholder="Search members..."
                class="search-input"
              />
              <div
                class="bulk-actions"
                style="
                  margin: 4px 0 6px;
                  display: flex;
                  gap: 6px;
                  flex-wrap: wrap;
                "
              >
                <button
                  type="button"
                  id="enableAllMembers"
                  class="mini-btn"
                  style="flex: 1 1 auto"
                >
                  Enable All
                </button>
                <button
                  type="button"
                  id="disableAllMembers"
                  class="mini-btn"
                  style="flex: 1 1 auto"
                >
                  Disable All
                </button>
              </div>
              <div id="memberDropdown" class="member-dropdown hidden">
                <div class="member-option" data-member="total">
                  <label
                    ><input type="checkbox" value="total" checked /><span
                      class="member-name"
                      >üìä Total Team Points</span
                    ></label
                  >
                </div>
              </div>
            </div>
            <small
              style="
                display: block;
                opacity: 0.6;
                margin-top: 4px;
                font-size: 11px;
              "
              >Select teams to compare across metrics. (collecting monthly data
              since September 04, 2023 and daily data since June 22,
              2025)</small
            >
            <div
              id="selectedMemberSeries"
              class="selected-series"
              style="margin-bottom: 8px"
            ></div>
          </div>
          <div class="control-block">
            <h3>Teams (Top 150)</h3>
            <div class="series-selector">
              <input
                type="text"
                id="teamSearch"
                placeholder="Search teams..."
                class="search-input"
              />
              <div
                class="bulk-actions"
                style="
                  margin: 4px 0 6px;
                  display: flex;
                  gap: 6px;
                  flex-wrap: wrap;
                "
              >
                <button
                  type="button"
                  id="enableAllTeams"
                  class="mini-btn"
                  style="flex: 1 1 auto"
                >
                  Enable All
                </button>
                <button
                  type="button"
                  id="disableAllTeams"
                  class="mini-btn"
                  style="flex: 1 1 auto"
                >
                  Disable All
                </button>
              </div>
              <div id="teamDropdown" class="member-dropdown hidden"></div>
              <div id="teamMetricWrapper" style="margin-top: 8px">
                <label
                  class="small-label"
                  style="
                    display: block;
                    font-size: 12px;
                    opacity: 0.8;
                    margin-bottom: 4px;
                  "
                  >Team Metric</label
                >
                <select id="teamMetric" class="modern-select">
                  <option value="total_points" selected>Total Points</option>
                  <option value="members">Members</option>
                  <option value="90_days">90 Days</option>
                  <option value="180_days">180 Days</option>
                </select>
              </div>
            </div>
            <small
              style="
                display: block;
                opacity: 0.6;
                margin-top: 4px;
                font-size: 11px;
              "
              >Select teams to compare across metrics. (collecting data since
              August 12, 2025)</small
            >
            <div
              id="selectedTeamSeries"
              class="selected-series"
              style="margin-top: 6px"
            ></div>
          </div>
          <div class="control-block predictions-block">
            <div class="predictions-header">
              <h3>Predictions</h3>
              <label class="switch" title="Enable predictions">
                <input type="checkbox" id="enablePredictions" />
                <span class="slider"></span>
              </label>
            </div>
            <div id="predictionOptions" class="prediction-options hidden">
              <label for="predictionMethod" class="pred-label">Method</label>
              <select id="predictionMethod" class="modern-select">
                <option value="linear">Linear Regression</option>
                <option value="moving_average">Moving Average</option>
              </select>
              <label for="predictionDays" class="pred-label">Days</label>
              <input
                type="number"
                id="predictionDays"
                value="30"
                min="7"
                max="365"
                class="number-input pred-days"
              />
            </div>
          </div>
        </aside>

        <main class="trends-chart-area" style="height: auto">
          <div class="chart-header">
            <h2 class="chart-title">Team Performance Trends</h2>
            <div class="chart-info"><span id="chartInfo">Loading...</span></div>
          </div>
          <div id="trendsChart" class="chart-area"></div>
          <div
            id="loadingSpinner"
            class="loading-overlay"
            style="display: none"
          >
            <div class="loading-content">
              <div class="loading-spinner"></div>
              <div class="loading-text">Loading trends data...</div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script>
      let availableMembers = [];
      let availableTeams = [];
      let selectedSeries = new Set(["total"]);
      let earliestDate = null;
      let bulkUpdatingMembers = false;
      let lastMemberClickIndex = null;
      let bulkUpdatingTeams = false;
      let lastTeamClickIndex = null;

      document.addEventListener("DOMContentLoaded", () => {
        createParticles();
        initDates();
        fetchMembers();
        fetchTeams();
        bindEvents();
      });

      function formatCompact(n) {
        if (n == null || isNaN(n)) return "0";
        const abs = Math.abs(n);
        if (abs >= 1_000_000) {
          // Show in whole millions as requested (3189291181 -> 3189 M)
          return Math.floor(abs / 1_000_000) + " M";
        } else if (abs >= 1_000) {
          return Math.floor(abs / 1_000) + "k";
        }
        return "" + abs; // keep small numbers unchanged
      }

      function createParticles() {
        const container = document.getElementById("particles");
        for (let i = 0; i < 20; i++) {
          const p = document.createElement("div");
          p.className = "particle";
          const s = Math.random() * 6 + 2;
          p.style.width = s + "px";
          p.style.height = s + "px";
          p.style.left = Math.random() * 100 + "%";
          p.style.top = Math.random() * 100 + "%";
          p.style.animationDelay = Math.random() * 8 + "s";
          p.style.animationDuration = Math.random() * 4 + 6 + "s";
          container.appendChild(p);
        }
      }

      function initDates() {
        const end = new Date();
        const start = new Date("2023-09-01T00:00:00");
        document.getElementById("endDate").value = fmt(end);
        document.getElementById("startDate").value = fmt(start);
      }
      function fmt(d) {
        return d.toISOString().split("T")[0];
      }

      function bindEvents() {
        document
          .querySelectorAll('input[name="chartType"]')
          .forEach((r) => r.addEventListener("change", updateChart));
        document.querySelectorAll('input[name="valueMode"]').forEach((r) =>
          r.addEventListener("change", () => {
            handleValueModeUI();
            enforceChartConstraints();
            updateChart();
          })
        );
        document
          .querySelectorAll('input[name="timePeriod"]')
          .forEach((r) => r.addEventListener("change", updateChart));
        document
          .getElementById("applyDateRange")
          .addEventListener("click", updateChart);
        document
          .querySelectorAll(".quick-ranges .mini-btn")
          .forEach((btn) =>
            btn.addEventListener("click", () =>
              setQuickRange(btn.dataset.range)
            )
          );
        document
          .getElementById("enablePredictions")
          .addEventListener("change", (e) => {
            document
              .getElementById("predictionOptions")
              .classList.toggle("hidden", !e.target.checked);
            updateChart();
          });
        document
          .getElementById("predictionMethod")
          .addEventListener("change", updateChart);
        document
          .getElementById("predictionDays")
          .addEventListener("change", updateChart);
        document
          .getElementById("fillLinesToggle")
          .addEventListener("change", updateChart);
        document
          .querySelectorAll('input[name="hoverMode"]')
          .forEach((r) => r.addEventListener("change", updateChart));
        document
          .getElementById("teamMetric")
          .addEventListener("change", updateChart);
        setupMemberSearch();
        setupTeamSearch();
        updateSelectedSeries();
        enforceChartConstraints();
        updateChart();
      }

      function setupMemberSearch() {
        const search = document.getElementById("memberSearch");
        const dropdown = document.getElementById("memberDropdown");
        search.addEventListener("focus", () =>
          openFloatingDropdown(dropdown, search)
        );
        search.addEventListener("input", () => {
          if (dropdown.classList.contains("hidden"))
            openFloatingDropdown(dropdown, search);
          filterMembers(search.value);
        });
        document.addEventListener("click", (e) => {
          if (e.target === search || e.target.closest("#memberDropdown"))
            return; // keep open if interacting with dropdown
          if (!e.target.closest(".series-selector"))
            dropdown.classList.add("hidden");
        });
      }

      function setupTeamSearch() {
        const search = document.getElementById("teamSearch");
        const dropdown = document.getElementById("teamDropdown");
        search.addEventListener("focus", () =>
          openFloatingDropdown(dropdown, search)
        );
        search.addEventListener("input", () => {
          if (dropdown.classList.contains("hidden"))
            openFloatingDropdown(dropdown, search);
          filterTeams(search.value);
        });
        document.addEventListener("click", (e) => {
          if (e.target === search || e.target.closest("#teamDropdown")) return;
          if (!e.target.closest(".series-selector"))
            dropdown.classList.add("hidden");
        });
      }

      function fetchMembers() {
        fetch("/api/trends/members")
          .then((r) => r.json())
          .then((data) => {
            if (!data.success) {
              console.warn("Members load failed", data.error);
              return;
            }
            availableMembers = data.members;
            earliestDate = data.earliest_date;
            populateMemberDropdown();
            updateSelectedSeries();
          })
          .catch((e) => console.error("Members error", e));
      }

      function fetchTeams() {
        fetch("/api/trends/teams")
          .then((r) => r.json())
          .then((data) => {
            if (!data.success) {
              console.warn("Teams load failed", data.error);
              return;
            }
            availableTeams = data.teams;
            populateTeamDropdown();
            updateSelectedSeries();
          })
          .catch((e) => console.error("Teams error", e));
      }

      function populateMemberDropdown() {
        const dropdown = document.getElementById("memberDropdown");
        availableMembers.forEach((m) => {
          const div = document.createElement("div");
          div.className = "member-option";
          div.dataset.member = m.name;
          const compact = formatCompact(m.current_points);
          const labelTitle = `${
            m.name
          } ‚Ä¢ ${m.current_points.toLocaleString()} pts`;
          // Use marquee-active only if rendered text would overflow max width (heuristic length > 18)
          const needsMarquee = m.name.length > 8;
          const nameClass =
            "member-name" + (needsMarquee ? " marquee-active" : "");
          // Duplicate text for smooth loop
          const marqueeInner = needsMarquee
            ? `<span class=\"marquee-track\"><span>${m.name}</span><span>${m.name}</span></span>`
            : `<span class=\"marquee-text\">${m.name}</span>`;
          div.innerHTML = `<label title="${labelTitle}"><input type=\"checkbox\" value=\"${m.name}\" /><span class=\"${nameClass}\">${marqueeInner}</span><span class=\"member-points\">${compact} pts</span></label>`;
          const cb = div.querySelector("input");
          cb.addEventListener("change", function () {
            if (bulkUpdatingMembers) return;
            if (this.checked) {
              selectedSeries.add(this.value);
            } else {
              selectedSeries.delete(this.value);
            }
            updateSelectedSeries();
            updateChart();
          });
          dropdown.appendChild(div);
        });
        // total checkbox
        const totalCb = dropdown.querySelector('input[value="total"]');
        totalCb.addEventListener("change", function () {
          if (bulkUpdatingMembers) return;
          if (this.checked) {
            selectedSeries.add("total");
          } else {
            selectedSeries.delete("total");
          }
          updateSelectedSeries();
          updateChart();
        });
        // Shift-click range selection via event delegation
        dropdown.addEventListener("click", function (e) {
          const input = e.target.closest('input[type="checkbox"]');
          if (!input) return;
          const checkboxes = Array.from(
            dropdown.querySelectorAll('input[type="checkbox"]')
          );
          const idx = checkboxes.indexOf(input);
          if (e.shiftKey && lastMemberClickIndex !== null) {
            bulkUpdatingMembers = true;
            const shouldCheck = input.checked;
            const start = Math.min(lastMemberClickIndex, idx);
            const end = Math.max(lastMemberClickIndex, idx);
            for (let i = start; i <= end; i++) {
              const cbx = checkboxes[i];
              cbx.checked = shouldCheck;
              if (shouldCheck) selectedSeries.add(cbx.value);
              else selectedSeries.delete(cbx.value);
            }
            bulkUpdatingMembers = false;
            updateSelectedSeries();
            updateChart();
          }
          lastMemberClickIndex = idx;
        });
        // Bulk action buttons
        document
          .getElementById("enableAllMembers")
          .addEventListener("click", () => {
            bulkUpdatingMembers = true;
            document
              .querySelectorAll('#memberDropdown input[type="checkbox"]')
              .forEach((cb) => {
                cb.checked = true;
                selectedSeries.add(cb.value);
              });
            bulkUpdatingMembers = false;
            updateSelectedSeries();
            updateChart();
          });
        document
          .getElementById("disableAllMembers")
          .addEventListener("click", () => {
            bulkUpdatingMembers = true;
            document
              .querySelectorAll('#memberDropdown input[type="checkbox"]')
              .forEach((cb) => {
                cb.checked = false;
              });
            selectedSeries.clear();
            bulkUpdatingMembers = false;
            updateSelectedSeries();
            updateChart();
          });
      }

      function populateTeamDropdown() {
        const dropdown = document.getElementById("teamDropdown");
        dropdown.innerHTML = "";
        availableTeams.forEach((t) => {
          const div = document.createElement("div");
          div.className = "member-option";
          div.dataset.team = t.name;
          const compact = formatCompact(t.total_points);
          const labelTitle = `${
            t.name
          } ‚Ä¢ ${t.total_points.toLocaleString()} pts`;
          const needsMarquee = t.name.length > 9; // unified threshold
          const nameClass =
            "member-name" + (needsMarquee ? " marquee-active" : "");
          const marqueeInner = needsMarquee
            ? `<span class=\"marquee-track\"><span>${t.name}</span><span>${t.name}</span></span>`
            : `<span class=\"marquee-text\">${t.name}</span>`;
          div.innerHTML = `<label title="${labelTitle}"><input type=\"checkbox\" value=\"team:${t.name}\" /><span class=\"${nameClass}\">${marqueeInner}</span><span class=\"member-points\">${compact} pts</span></label>`;
          const cb = div.querySelector("input");
          cb.addEventListener("change", function () {
            if (bulkUpdatingTeams) return;
            if (this.checked) {
              selectedSeries.add(this.value);
            } else {
              selectedSeries.delete(this.value);
            }
            updateSelectedSeries();
            updateChart();
          });
          dropdown.appendChild(div);
        });
        // Shift-click range selection for teams
        dropdown.addEventListener("click", function (e) {
          const input = e.target.closest('input[type="checkbox"]');
          if (!input) return;
          const checkboxes = Array.from(
            dropdown.querySelectorAll('input[type="checkbox"]')
          );
          const idx = checkboxes.indexOf(input);
          if (e.shiftKey && lastTeamClickIndex !== null) {
            bulkUpdatingTeams = true;
            const shouldCheck = input.checked;
            const start = Math.min(lastTeamClickIndex, idx);
            const end = Math.max(lastTeamClickIndex, idx);
            for (let i = start; i <= end; i++) {
              const cbx = checkboxes[i];
              cbx.checked = shouldCheck;
              if (shouldCheck) selectedSeries.add(cbx.value);
              else selectedSeries.delete(cbx.value);
            }
            bulkUpdatingTeams = false;
            updateSelectedSeries();
            updateChart();
          }
          lastTeamClickIndex = idx;
        });
        document
          .getElementById("enableAllTeams")
          .addEventListener("click", () => {
            bulkUpdatingTeams = true;
            dropdown
              .querySelectorAll('input[type="checkbox"]')
              .forEach((cb) => {
                cb.checked = true;
                selectedSeries.add(cb.value);
              });
            bulkUpdatingTeams = false;
            updateSelectedSeries();
            updateChart();
          });
        document
          .getElementById("disableAllTeams")
          .addEventListener("click", () => {
            bulkUpdatingTeams = true;
            dropdown
              .querySelectorAll('input[type="checkbox"]')
              .forEach((cb) => {
                cb.checked = false;
              });
            // Remove only team: series; keep members
            Array.from(selectedSeries).forEach((v) => {
              if (v.startsWith("team:")) selectedSeries.delete(v);
            });
            bulkUpdatingTeams = false;
            updateSelectedSeries();
            updateChart();
          });
      }

      // Continuous marquee hover logic
      document.addEventListener("mouseover", function (e) {
        const target = e.target.closest(".member-name.marquee-active");
        if (!target) return;
        if (target.classList.contains("hovering")) return;
        const track = target.querySelector(".marquee-track");
        if (!track) return;
        const firstSpan = track.querySelector("span");
        if (!firstSpan) return;
        // full text width
        const textWidth = firstSpan.getBoundingClientRect().width;
        const containerWidth = target.getBoundingClientRect().width;
        if (textWidth <= containerWidth) return; // no overflow
        // distance for one full loop (text + gap) limited so animation is smooth
        const gap = 40; // keep in sync with CSS gap
        const distance = textWidth + gap;
        target.style.setProperty("--marquee-distance", distance + "px");
        // duration proportional to distance (e.g., 120px per second)
        const seconds = Math.max(6, Math.min(18, distance / 120));
        target.style.setProperty("--marquee-duration", seconds + "s");
        target.classList.add("hovering");
        // Apply animation dynamically so removing hover resets position
        track.style.animation = `marquee ${seconds}s linear infinite`;
      });
      document.addEventListener("mouseout", function (e) {
        const target = e.target.closest(".member-name.marquee-active");
        if (!target) return;
        target.classList.remove("hovering");
        const track = target.querySelector(".marquee-track");
        if (track) {
          // Remove animation & reset transform to origin
          track.style.animation = "none";
          track.style.transform = "translateX(0)";
          // Force reflow so future hover restarts cleanly
          void track.offsetWidth;
        }
      });

      function filterMembers(term) {
        const options = document.querySelectorAll(
          "#memberDropdown .member-option"
        );
        const q = (term || "").toLowerCase();
        options.forEach((o) => {
          const name = (o.dataset.member || "").toLowerCase();
          if (name === "total") {
            o.style.display = "block";
            return;
          }
          const show = !q || name.includes(q);
          o.style.display = show ? "block" : "none";
        });
      }

      function filterTeams(term) {
        const options = document.querySelectorAll(
          "#teamDropdown .member-option"
        );
        options.forEach((o) => {
          const show = o.dataset.team
            .toLowerCase()
            .includes(term.toLowerCase());
          o.style.display = show ? "block" : "none";
        });
      }

      function updateSelectedSeries() {
        const memberContainer = document.getElementById("selectedMemberSeries");
        const teamContainer = document.getElementById("selectedTeamSeries");
        memberContainer.innerHTML = "";
        teamContainer.innerHTML = "";
        selectedSeries.forEach((s) => {
          const tag = document.createElement("div");
          tag.className = "series-tag";
          let label;
          if (s === "total") label = "üìä Total Team Points";
          else if (s.startsWith("team:")) label = "üèÜ " + s.substring(5);
          else label = s;
          tag.innerHTML = `<span>${label}</span><button class="remove-series" data-series="${s}">√ó</button>`;
          tag.querySelector("button").addEventListener("click", function () {
            selectedSeries.delete(this.dataset.series);
            const cb = document.querySelector(
              `input[value="${CSS.escape(this.dataset.series)}"]`
            );
            if (cb) cb.checked = false;
            updateSelectedSeries();
            updateChart();
          });
          if (s.startsWith("team:")) teamContainer.appendChild(tag);
          else memberContainer.appendChild(tag);
        });
        const anyTeam = Array.from(selectedSeries).some((s) =>
          s.startsWith("team:")
        );
        document.getElementById("teamMetricWrapper").style.display = anyTeam
          ? "block"
          : "none";
      }

      function setQuickRange(r) {
        const end = new Date();
        let start = new Date();
        if (r === "1m") start.setMonth(end.getMonth() - 1);
        else if (r === "3m") start.setMonth(end.getMonth() - 3);
        else if (r === "6m") start.setMonth(end.getMonth() - 6);
        else if (r === "1y") start.setFullYear(end.getFullYear() - 1);
        else if (r === "all" && earliestDate) {
          start = new Date(earliestDate + "T00:00:00");
        }
        document.getElementById("endDate").value = fmt(end);
        document.getElementById("startDate").value = fmt(start);
        updateChart();
      }

      function updateChart() {
        if (selectedSeries.size === 0) {
          document.getElementById("chartInfo").textContent =
            "Select at least one series";
          return;
        }
        toggleLoading(true);
        const valueMode = document.querySelector(
          'input[name="valueMode"]:checked'
        ).value;
        enforceChartConstraints();
        const params = new URLSearchParams({
          chart_type: document.querySelector('input[name="chartType"]:checked')
            .value,
          time_period: document.querySelector(
            'input[name="timePeriod"]:checked'
          ).value,
          start_date: document.getElementById("startDate").value,
          end_date: document.getElementById("endDate").value,
          series: Array.from(selectedSeries).join(","),
          value_mode: valueMode,
          predictions: document.getElementById("enablePredictions").checked,
          prediction_method: document.getElementById("predictionMethod").value,
          prediction_days: document.getElementById("predictionDays").value,
          fill_lines: document.getElementById("fillLinesToggle").checked,
        });
        if (Array.from(selectedSeries).some((s) => s.startsWith("team:"))) {
          params.set(
            "team_metric",
            document.getElementById("teamMetric").value
          );
        }
        fetch(`/api/trends/data?${params.toString()}`)
          .then((r) => r.json())
          .then((data) => {
            if (data.success) {
              renderChart(data);
              updateInfo(data);
            } else {
              showError(data.error || "Failed to load data");
            }
          })
          .catch((e) => {
            console.error(e);
            showError("Error loading chart data");
          })
          .finally(() => toggleLoading(false));
      }

      function enforceChartConstraints() {
        const tp = document.querySelector(
          'input[name="timePeriod"]:checked'
        ).value;
        const valueMode = document.querySelector(
          'input[name="valueMode"]:checked'
        ).value;
        const cOpt = document.getElementById("candlestick-option");
        const csInput = cOpt.querySelector("input");
        const allowed = true; // allow candlesticks for all periods including daily
        // Toggle fill lines control only for line chart type
        const isLine =
          document.querySelector('input[name="chartType"]:checked').value ===
          "line";
        document.getElementById("fillLinesWrapper").style.display = isLine
          ? "block"
          : "none";
        if (!allowed) {
          cOpt.classList.add("disabled");
          csInput.disabled = true;
          if (csInput.checked) {
            document.querySelector(
              'input[name="chartType"][value="line"]'
            ).checked = true;
          }
        } else {
          cOpt.classList.remove("disabled");
          csInput.disabled = false;
        }
      }

      function renderChart(payload) {
        applyVerticalLegend(payload.layout);
        // Apply user-selected hover mode
        const hoverMode = document.querySelector(
          'input[name="hoverMode"]:checked'
        );
        if (hoverMode) {
          payload.layout.hovermode = hoverMode.value;
        }
        Plotly.newPlot(
          "trendsChart",
          payload.data,
          payload.layout,
          payload.config
        ).then(() => {
          // Clamp chart div height within specified bounds
          const chartDiv = document.getElementById("trendsChart");
          const h = chartDiv.getBoundingClientRect().height;
          if (h < 300) {
            chartDiv.style.height = "300px";
            Plotly.Plots.resize(chartDiv);
          } else if (h > 460) {
            chartDiv.style.height = "460px";
            Plotly.Plots.resize(chartDiv);
          }
        });
      }

      function applyVerticalLegend(layout) {
        if (!layout) return;
        layout.legend = Object.assign({}, layout.legend || {}, {
          orientation: "v",
          x: 1.02,
          xanchor: "left",
          y: 1,
          yanchor: "top",
        });
        layout.margin = layout.margin || {};
        layout.margin.r = Math.max(layout.margin.r || 80, 180); // space for legend labels
      }

      function updateInfo(payload) {
        const info = document.getElementById("chartInfo");
        const count = selectedSeries.size;
        const tp = document.querySelector(
          'input[name="timePeriod"]:checked'
        ).value;
        info.textContent = `${count} series ‚Ä¢ ${tp} ‚Ä¢ ${
          payload.data_points || 0
        } days`;
      }

      function handleValueModeUI() {
        const mode = document.querySelector(
          'input[name="valueMode"]:checked'
        ).value;
        const yLabel = mode === "interval" ? "Points Produced" : "Points";
        const chart = document.getElementById("trendsChart");
        if (chart && chart.data) {
          Plotly.relayout("trendsChart", { "yaxis.title.text": yLabel });
        }
      }

      function toggleLoading(show) {
        const spinner = document.getElementById("loadingSpinner");
        const chart = document.getElementById("trendsChart");
        if (show) {
          spinner.style.display = "flex";
          chart.style.opacity = "0.3";
        } else {
          spinner.style.display = "none";
          chart.style.opacity = "1";
        }
      }

      function showError(msg) {
        const info = document.getElementById("chartInfo");
        info.textContent = "Error: " + msg;
        info.style.color = "#ff6b6b";
        setTimeout(() => (info.style.color = ""), 5000);
      }

      // Floating dropdown portal logic
      function openFloatingDropdown(dropdown, anchor) {
        // Ensure content built before measuring
        dropdown.classList.remove("hidden");
        // Add floating class & move to body if not already
        if (!dropdown.classList.contains("floating-dropdown")) {
          dropdown.classList.add("floating-dropdown");
          document.body.appendChild(dropdown);
        }
        dropdown.style.zIndex = "999999";
        positionFloatingDropdown(dropdown, anchor);
      }
      function positionFloatingDropdown(dropdown, anchor) {
        const rect = anchor.getBoundingClientRect();
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const desiredWidth = rect.width;
        dropdown.style.width = desiredWidth + "px";
        // Temporarily set to auto to measure height
        dropdown.style.maxHeight = "calc( min(320px, 60vh) )";
        const ddRect = dropdown.getBoundingClientRect();
        let top = rect.bottom + 4; // below input
        let left = rect.left;
        // If not enough space below, place above
        if (top + ddRect.height > vh - 10) {
          top = rect.top - ddRect.height - 4;
        }
        // Clamp horizontally
        if (left + ddRect.width > vw - 8) {
          left = vw - ddRect.width - 8;
        }
        if (left < 4) left = 4;
        if (top < 4) top = 4;
        dropdown.style.top = top + "px";
        dropdown.style.left = left + "px";
      }
      window.addEventListener("resize", () => {
        const md = document.getElementById("memberDropdown");
        if (!md.classList.contains("hidden"))
          positionFloatingDropdown(md, document.getElementById("memberSearch"));
        const td = document.getElementById("teamDropdown");
        if (!td.classList.contains("hidden"))
          positionFloatingDropdown(td, document.getElementById("teamSearch"));
      });
      window.addEventListener(
        "scroll",
        () => {
          const md = document.getElementById("memberDropdown");
          if (!md.classList.contains("hidden"))
            positionFloatingDropdown(
              md,
              document.getElementById("memberSearch")
            );
          const td = document.getElementById("teamDropdown");
          if (!td.classList.contains("hidden"))
            positionFloatingDropdown(td, document.getElementById("teamSearch"));
        },
        true
      );
    </script>
  </body>
</html>
