{% extends "base.html" %} {% block title %}I.B.U. Team Info{% endblock %} {%
block head %} {{ super() }}
<!-- jQuery and jQuery UI for custom datepicker -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link
  rel="stylesheet"
  href="https://code.jquery.com/ui/1.13.2/themes/ui-lightness/jquery-ui.css"
/>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<link
  rel="icon"
  type="image/svg+xml"
  href="{{ url_for('static', filename='ibu-icon.svg') }}"
/>

{% endblock %} {% block content %}
<div class="mx-auto w-full max-w-6xl px-4 py-6">
  <!-- Header -->
  <header
    class="rounded-2xl border border-white/10 bg-neutral-800 p-5 shadow-sm"
  >
    <div
      class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between"
    >
      <div>
        <h1 class="text-xl font-semibold tracking-wide text-white">
          Team Info
        </h1>
        <p class="mt-1 text-sm text-white/70">
          Data from {{ time_ago }} ({{ latest_date }})
        </p>
      </div>

      <!-- Range Selector -->
      <div class="w-full sm:w-auto">
        <label for="chartSelector" class="sr-only">Select Date Range</label>
        <select
          id="chartSelector"
          class="w-full sm:w-56 rounded-xl border border-white/10 bg-neutral-800 py-2.5 px-3 text-sm text-white focus:border-white/20 focus:bg-white/10"
        >
          <option class="text-black bg-white" value="total">All Time</option>
          <option class="text-black bg-white" value="last_day">Last Day</option>
          <option class="text-black bg-white" value="last_week">
            Last Week
          </option>
          <option class="text-black bg-white" value="last_month">
            Last Month
          </option>
          <option class="text-black bg-white" value="last_90_days">
            Last 90 Days
          </option>
          <option class="text-black bg-white" value="last_180_days">
            Last 180 Days
          </option>
          <option class="text-black bg-white" value="last_year">
            Last Year
          </option>
          <option class="text-black bg-white" value="custom">
            Custom Date
          </option>
        </select>
      </div>
    </div>

    <!-- Custom Date Controls -->
    <div id="dateControls" class="mt-4 hidden">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
        <input
          type="text"
          id="startDate"
          class="custom-datepicker w-full sm:w-44 rounded-xl border border-white/10 bg-neutral-800 py-2.5 px-3 text-sm text-white placeholder:text-white/40 outline-none focus:border-white/20 focus:bg-white/10"
          placeholder="Start Date"
          readonly
        />
        <input
          type="text"
          id="endDate"
          class="custom-datepicker w-full sm:w-44 rounded-xl border border-white/10 bg-neutral-800 py-2.5 px-3 text-sm text-white placeholder:text-white/40 outline-none focus:border-white/20 focus:bg-white/10"
          placeholder="End Date"
          readonly
        />
        <button
          id="applyCustomRange"
          type="button"
          class="inline-flex items-center justify-center rounded-xl bg-emerald-500 px-4 py-2.5 text-sm font-medium text-white shadow-sm hover:bg-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-300/60"
        >
          Apply Range
        </button>
      </div>
    </div>
  </header>

  <!-- Chart Card -->
  <main class="mt-4">
    <section
      class="overflow-hidden rounded-xl bg-neutral-800 border border-white/10"
    >
      <div class="border-b border-white/10 px-4 py-3">
        <h2 class="text-sm font-semibold text-white/80">
          Team Performance Analysis
        </h2>
      </div>

      <div class="relative p-4">
        <div id="pointsPieChart" class="h-[720px] w-full"></div>

        <!-- Loading overlay -->
        <div
          id="loadingOverlay"
          class="absolute inset-0 hidden items-center justify-center bg-black/60 backdrop-blur-sm"
        >
          <div class="flex flex-col items-center gap-3 text-center">
            <div
              class="h-10 w-10 animate-spin rounded-full border-4 border-white/20 border-t-white/80"
            ></div>
            <div class="text-sm font-medium text-white">
              Loading chart data...
            </div>
            <div class="text-xs text-white/70">
              Please wait while we fetch your data
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>
<script>
  (() => {
    Chart.register(ChartDataLabels);

    const el = {
      container: document.getElementById("pointsPieChart"),
      selector: document.getElementById("chartSelector"),
      dateControls: document.getElementById("dateControls"),
      startDate: document.getElementById("startDate"),
      endDate: document.getElementById("endDate"),
      applyBtn: document.getElementById("applyCustomRange"),
      overlay: document.getElementById("loadingOverlay"),
    };

    const canvas = document.createElement("canvas");
    canvas.style.width = "100%";
    canvas.style.height = "100%";
    el.container.innerHTML = "";
    el.container.appendChild(canvas);

    // Center text plugin
    const centerTextPlugin = {
      id: "centerText",
      afterDraw(chart, args, opts) {
        if (!opts?.line1 && !opts?.line2) return;
        const meta = chart.getDatasetMeta(0);
        if (!meta?.data?.length) return;

        const { ctx } = chart;
        const x = meta.data[0].x;
        const y = meta.data[0].y;

        ctx.save();
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        ctx.font = "600 14px Inter, Arial, sans-serif";
        ctx.fillStyle = "rgba(226,232,240,0.95)";
        ctx.fillText(opts.line1 || "", x, y - 10);

        ctx.font = "700 22px Inter, Arial, sans-serif";
        ctx.fillStyle = "rgba(224,97,80,0.95)";
        ctx.fillText(opts.line2 || "", x, y + 18);

        ctx.restore();
      },
    };
    Chart.register(centerTextPlugin);

    let chart = null;

    function showLoading(on) {
      if (!el.overlay) return;
      el.overlay.classList.toggle("hidden", !on);
      el.overlay.classList.toggle("flex", on);
    }

    function setCustomControlsVisible(on) {
      if (!el.dateControls) return;
      el.dateControls.classList.toggle("hidden", !on);
    }

    function colorForIndex(i) {
      const hue = (i * 47) % 360;
      return `hsl(${hue} 70% 55%)`;
    }

    function normalize(resp) {
      if (!resp || resp.error) throw new Error(resp?.error || "Bad response.");

      const labels = Array.isArray(resp.labels) ? resp.labels : [];
      const values = Array.isArray(resp.values) ? resp.values : [];
      if (!labels.length || labels.length !== values.length)
        throw new Error("labels/values mismatch.");

      const colors =
        Array.isArray(resp.colors) && resp.colors.length === values.length
          ? resp.colors
          : values.map((_, i) => colorForIndex(i));

      const hole = resp.meta?.hole ?? 0.6;
      const cutout = `${Math.round(Number(hole) * 100)}%`;

      const total = resp.meta?.total ?? values.reduce((a, b) => a + b, 0);
      const active =
        resp.meta?.active_members ?? values.filter((v) => v > 0).length;

      return { labels, values, colors, cutout, total, active };
    }

    function renderOrUpdate(ds) {
      const cfg = {
        type: "doughnut",
        data: {
          labels: ds.labels,
          datasets: [
            {
              data: ds.values,
              backgroundColor: ds.colors,
              borderColor: "rgba(255,255,255,0.20)",
              borderWidth: 1,
              hoverOffset: 8,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: ds.cutout,
          plugins: {
            legend: {
              position: "right",
              labels: {
                color: "rgba(226,232,240,0.95)",
                boxWidth: 14,
                boxHeight: 14,
                padding: 12,
              },
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.parsed;
                  const pct = ds.total ? (v / ds.total) * 100 : 0;
                  return ` ${ctx.label}: ${Number(v).toLocaleString()} (${pct.toFixed(1)}%)`;
                },
              },
            },
            datalabels: {
              color: "rgba(255,255,255,0.92)",
              font: { weight: "600", size: 11 },
              formatter: (value) => {
                const pct = ds.total ? (value / ds.total) * 100 : 0;
                if (pct < 2.5) return "";
                return `${pct.toFixed(0)}%`;
              },
            },
            centerText: {
              line1: "Total Points",
              line2: Number(ds.total).toLocaleString(),
            },
          },
        },
      };

      if (chart) {
        chart.data = cfg.data;
        chart.options = cfg.options;
        chart.update();
      } else {
        chart = new Chart(canvas.getContext("2d"), cfg);
      }
    }

    function showError(message) {
      el.container.innerHTML = `
      <div class="flex h-full min-h-[240px] items-center justify-center text-center">
        <div class="max-w-lg px-4">
          <div class="text-sm font-semibold text-slate-100">Chart error</div>
          <div class="mt-2 text-sm text-slate-300">${message}</div>
        </div>
      </div>
    `;
    }

    async function fetchRange(type, startISO, endISO) {
      const params = new URLSearchParams({ type });
      if (type === "custom" && startISO && endISO) {
        params.set("start", startISO);
        params.set("end", endISO);
      }
      const res = await fetch(`/get_chart_data?${params.toString()}`, {
        headers: { Accept: "application/json" },
      });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json?.error || "Failed to load chart data.");
      return json;
    }

    async function loadAndRender(type, startISO, endISO) {
      showLoading(true);
      try {
        if (!el.container.contains(canvas)) {
          el.container.innerHTML = "";
          el.container.appendChild(canvas);
        }
        const resp = await fetchRange(type, startISO, endISO);
        const ds = normalize(resp);
        renderOrUpdate(ds);
      } catch (e) {
        console.error(e);
        showError(e.message || "Unknown error");
      } finally {
        showLoading(false);
      }
    }

    $(".custom-datepicker").datepicker({
      dateFormat: "yy-mm-dd",
      changeMonth: true,
      changeYear: true,
      maxDate: 0,
    });

    setCustomControlsVisible(el.selector.value === "custom");

    el.selector.addEventListener("change", () => {
      const type = el.selector.value;
      const isCustom = type === "custom";
      setCustomControlsVisible(isCustom);
      if (!isCustom) loadAndRender(type);
    });

    el.applyBtn.addEventListener("click", () => {
      const start = el.startDate.value;
      const end = el.endDate.value;
      if (!start || !end)
        return showError("Pick both a start date and an end date.");
      if (start > end) return showError("Start date must be before end date.");
      loadAndRender("custom", start, end);
    });

    loadAndRender(el.selector.value || "total");
  })();
</script>

{% endblock %}
