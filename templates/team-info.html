{% extends "base.html" %} {% block title %}I.B.U. Team Info{% endblock %} {%
block head %} {{ super() }}

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link
  rel="stylesheet"
  href="https://code.jquery.com/ui/1.13.2/themes/ui-lightness/jquery-ui.css"
/>

<script src="https://cdn.jsdelivr.net/npm/apexcharts@5.3.6"></script>

<link
  rel="icon"
  type="image/svg+xml"
  href="{{ url_for('static', filename='ibu-icon.svg') }}"
/>
{% endblock %} {% block content %}
<div class="mx-auto w-full max-w-6xl px-4 py-6">
  <!-- Header -->
  <header
    class="rounded-2xl border border-white/10 bg-neutral-800 p-5 shadow-sm"
  >
    <div
      class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between"
    >
      <div>
        <h1 class="text-xl font-semibold tracking-wide text-white">
          Team Info
        </h1>
        <p class="mt-1 text-sm text-white/70">
          Data from {{ time_ago }} ({{ latest_date }})
        </p>
      </div>

      <!-- Range Selector -->
      <div class="w-full sm:w-auto">
        <label for="chartSelector" class="sr-only">Select Date Range</label>
        <select
          id="chartSelector"
          class="w-full sm:w-56 rounded-xl border border-white/10 bg-neutral-800 py-2.5 px-3 text-sm text-white focus:border-white/20 focus:bg-white/10"
        >
          <option class="text-black bg-white" value="total">All Time</option>
          <option class="text-black bg-white" value="last_day">Last Day</option>
          <option class="text-black bg-white" value="last_week">
            Last Week
          </option>
          <option class="text-black bg-white" value="last_month">
            Last Month
          </option>
          <option class="text-black bg-white" value="last_90_days">
            Last 90 Days
          </option>
          <option class="text-black bg-white" value="last_180_days">
            Last 180 Days
          </option>
          <option class="text-black bg-white" value="last_year">
            Last Year
          </option>
          <option class="text-black bg-white" value="custom">
            Custom Date
          </option>
        </select>
      </div>
    </div>

    <!-- Custom Date Controls -->
    <div id="dateControls" class="mt-4 hidden">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
        <input
          type="text"
          id="startDate"
          class="custom-datepicker w-full sm:w-44 rounded-xl border border-white/10 bg-neutral-800 py-2.5 px-3 text-sm text-white placeholder:text-white/40 outline-none focus:border-white/20 focus:bg-white/10"
          placeholder="Start Date"
          readonly
        />
        <input
          type="text"
          id="endDate"
          class="custom-datepicker w-full sm:w-44 rounded-xl border border-white/10 bg-neutral-800 py-2.5 px-3 text-sm text-white placeholder:text-white/40 outline-none focus:border-white/20 focus:bg-white/10"
          placeholder="End Date"
          readonly
        />
        <button
          id="applyCustomRange"
          type="button"
          class="inline-flex items-center justify-center rounded-xl bg-emerald-500 px-4 py-2.5 text-sm font-medium text-white shadow-sm hover:bg-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-300/60"
        >
          Apply Range
        </button>
      </div>
    </div>
  </header>

  <!-- Chart Card -->
  <main class="mt-4">
    <section
      class="overflow-hidden rounded-xl bg-neutral-800 border border-white/10"
    >
      <div class="border-b border-white/10 px-4 py-3">
        <h2 class="text-sm font-semibold text-white/80">
          Team Performance Analysis
        </h2>
      </div>

      <div class="relative p-4">
        <div id="pointsPieChart" class="h-[720px] w-full"></div>

        <!-- Loading overlay -->
        <div
          id="loadingOverlay"
          class="absolute inset-0 hidden items-center justify-center bg-black/60 backdrop-blur-sm"
        >
          <div class="flex flex-col items-center gap-3 text-center">
            <div
              class="h-10 w-10 animate-spin rounded-full border-4 border-white/20 border-t-white/80"
            ></div>
            <div class="text-sm font-medium text-white">
              Loading chart data...
            </div>
            <div class="text-xs text-white/70">
              Please wait while we fetch your data
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>
<script>
  (() => {
    const el = {
      container: document.getElementById("pointsPieChart"),
      selector: document.getElementById("chartSelector"),
      dateControls: document.getElementById("dateControls"),
      startDate: document.getElementById("startDate"),
      endDate: document.getElementById("endDate"),
      applyBtn: document.getElementById("applyCustomRange"),
      overlay: document.getElementById("loadingOverlay"),
    };

    let chart = null;

    function showLoading(on) {
      if (!el.overlay) return;
      el.overlay.classList.toggle("hidden", !on);
      el.overlay.classList.toggle("flex", on);
    }

    function setCustomControlsVisible(on) {
      if (!el.dateControls) return;
      el.dateControls.classList.toggle("hidden", !on);
    }

    function colorForIndex(i) {
      const hue = (i * 47) % 360;
      return `hsl(${hue} 70% 55%)`;
    }

    function normalize(resp) {
      if (!resp || resp.error) throw new Error(resp?.error || "Bad response.");

      const labels = Array.isArray(resp.labels) ? resp.labels : [];
      const values = Array.isArray(resp.values) ? resp.values : [];
      if (!labels.length || labels.length !== values.length)
        throw new Error("labels/values mismatch.");

      const colors =
        Array.isArray(resp.colors) && resp.colors.length === values.length
          ? resp.colors
          : values.map((_, i) => colorForIndex(i));

      const sorted = labels
        .map((label, i) => ({
          label: String(label),
          value: Number(values[i]) || 0,
          color: colors[i] ?? colorForIndex(i),
        }))
        .sort((a, b) => b.value - a.value || a.label.localeCompare(b.label));

      const sortedLabels = sorted.map((x) => x.label);
      const sortedValues = sorted.map((x) => x.value);
      const sortedColors = sorted.map((x) => x.color);

      const total = resp.meta?.total ?? sortedValues.reduce((a, b) => a + b, 0);
      const hole = resp.meta?.hole ?? 0.6;
      const donutSize = `${Math.round(Number(hole) * 100)}%`;

      return {
        labels: sortedLabels,
        values: sortedValues,
        colors: sortedColors,
        total,
        donutSize,
      };
    }

    function destroyChart() {
      if (chart) {
        chart.destroy();
        chart = null;
      }
      el.container.innerHTML = "";
    }

    function renderOrUpdate(ds) {
      const options = {
        chart: {
          type: "donut",
          height: 720,
          background: "transparent",
          animations: { enabled: true },
          toolbar: { show: false },
        },
        series: ds.values,
        labels: ds.labels,
        colors: ds.colors,
        stroke: {
          show: true,
          width: 1,
          colors: ["rgba(255,255,255,0.20)"],
        },
        legend: {
          position: "right",
          labels: { colors: "rgba(226,232,240,0.95)" },
          fontSize: "13px",
          itemMargin: { vertical: 6, horizontal: 10 },
        },
        dataLabels: {
          enabled: true,
          style: {
            fontSize: "11px",
            fontWeight: 600,
            colors: ["rgba(255,255,255,0.92)"],
          },
          dropShadow: { enabled: false },
          formatter: function (val) {
            if (val < 2.5) return "";
            return `${Math.round(val)}%`;
          },
        },
        tooltip: {
          theme: "dark",
          y: {
            formatter: function (value, opts) {
              const numericValue = Number(value) || 0;
              const idxCandidates = [
                opts?.dataPointIndex,
                opts?.seriesIndex,
                opts?.w?.globals?.series?.findIndex?.(
                  (v) => Number(v) === numericValue,
                ),
                ds.values.findIndex((v) => Number(v) === numericValue),
              ];
              const idx =
                idxCandidates.find((i) => Number.isInteger(i) && i >= 0) ?? -1;

              // Use the same source as the right-side legend first.
              const rawLabel =
                ds.labels?.[idx] ??
                opts?.w?.globals?.labels?.[idx] ??
                opts?.w?.config?.labels?.[idx] ??
                "Unknown user";
              const label = String(rawLabel);
              const pct = ds.total ? (numericValue / ds.total) * 100 : 0;
              return `${label}: ${numericValue.toLocaleString()} (${pct.toFixed(1)}%)`;
            },
            title: { formatter: () => "" },
          },
        },
        plotOptions: {
          pie: {
            donut: {
              size: ds.donutSize,
              labels: {
                show: true,
                name: {
                  show: true,
                  offsetY: -10,
                  color: "rgba(226,232,240,0.95)",
                  fontSize: "14px",
                  fontWeight: 600,
                  formatter: () => "Total Points",
                },
                value: {
                  show: true,
                  offsetY: 18,
                  color: "rgba(224,97,80,0.95)",
                  fontSize: "22px",
                  fontWeight: 700,
                  formatter: () => Number(ds.total).toLocaleString(),
                },
                total: {
                  show: false,
                },
              },
            },
          },
        },
        responsive: [
          {
            breakpoint: 640,
            options: {
              legend: { position: "bottom" },
              chart: { height: 520 },
            },
          },
        ],
      };

      if (!chart) {
        chart = new ApexCharts(el.container, options);
        chart.render();
        return;
      }

      chart.updateOptions(
        {
          labels: ds.labels,
          colors: ds.colors,
          plotOptions: options.plotOptions,
          legend: options.legend,
          tooltip: options.tooltip,
          dataLabels: options.dataLabels,
          stroke: options.stroke,
          responsive: options.responsive,
        },
        false,
        true,
      );

      chart.updateSeries(ds.values, true);
    }

    function showError(message) {
      destroyChart();
      el.container.innerHTML = `
        <div class="flex h-full min-h-[240px] items-center justify-center text-center">
          <div class="max-w-lg px-4">
            <div class="text-sm font-semibold text-slate-100">Chart error</div>
            <div class="mt-2 text-sm text-slate-300">${message}</div>
          </div>
        </div>
      `;
    }

    async function fetchRange(type, startISO, endISO) {
      const params = new URLSearchParams({ type });
      if (type === "custom" && startISO && endISO) {
        params.set("start", startISO);
        params.set("end", endISO);
      }
      const res = await fetch(`/get_chart_data?${params.toString()}`, {
        headers: { Accept: "application/json" },
      });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json?.error || "Failed to load chart data.");
      return json;
    }

    async function loadAndRender(type, startISO, endISO) {
      showLoading(true);
      try {
        const resp = await fetchRange(type, startISO, endISO);
        const ds = normalize(resp);
        renderOrUpdate(ds);
      } catch (e) {
        console.error(e);
        showError(e.message || "Unknown error");
      } finally {
        showLoading(false);
      }
    }

    $(".custom-datepicker").datepicker({
      dateFormat: "yy-mm-dd",
      changeMonth: true,
      changeYear: true,
      maxDate: 0,
    });

    setCustomControlsVisible(el.selector.value === "custom");

    el.selector.addEventListener("change", () => {
      const type = el.selector.value;
      const isCustom = type === "custom";
      setCustomControlsVisible(isCustom);
      if (!isCustom) loadAndRender(type);
    });

    el.applyBtn.addEventListener("click", () => {
      const start = el.startDate.value;
      const end = el.endDate.value;
      if (!start || !end)
        return showError("Pick both a start date and an end date.");
      if (start > end) return showError("Start date must be before end date.");
      loadAndRender("custom", start, end);
    });

    loadAndRender(el.selector.value || "total");
  })();
</script>

{% endblock %}
